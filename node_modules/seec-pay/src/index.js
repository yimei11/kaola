const _this = {
  self: {
    show: () => {}
  }
}
wx.seecRequestPayment = ({
  timeStamp = '', // 时间戳，从1970年1月1日00:00:00至今的秒数，即当前的时间
  nonceStr = '', // 随机字符串，长度为32个字符以下
  _package = '', // 统一下单接口返回的 prepay_id 参数值，提交格式如：prepay_id=***
  signType = '', // 签名算法，应与后台下单时的值一致
  paySign = '', // 签名，具体见微信支付文档
  success = () => {},
  fail = () => {},
  complete = () => {}
} = {}) => {
  _this.timeStamp = timeStamp
  _this.nonceStr = nonceStr
  _this._package = _package
  _this.signType = signType
  _this.paySign = paySign
  _this.success = success
  _this.fail = fail
  _this.complete = complete
  if (_package.split('=').length !== 2 || paySign.split('##').length !== 6) {
    _this.fail({
      errMsg: '参数错误'
    })
    _this.complete({
      errMsg: '参数错误'
    })
    return
  }
  _this.self.show()
}

Component({
  data: {
    title: '',
    total: '0.00',
    show: false,
    open: false,
    success: false,
    pw: [],
    tempRes: null
  },
  lifetimes: {
    created() {
      _this.self = this
    }
  },
  methods: {
    show() {
      const arr = _this.paySign.split('##')
      this.setData({
        title: decodeURIComponent(arr[4]),
        total: Number(arr[3]).toFixed(2),
        show: true
      })
      setTimeout(() => {
        this.setData({
          open: true
        })
      }, 300)
    },
    hide() {
      this.setData({
        title: '',
        total: '0.00',
        show: false,
        open: false,
        success: false,
        pw: [],
        tempRes: null
      })
    },
    close() {
      _this.fail({
        errMsg: '支付未完成'
      })
      _this.complete({
        errMsg: '支付未完成'
      })
      this.hide()
    },
    keyboard({target: {dataset: {num}}}) {
      if (num === undefined) return
      if (num === '-1' && this.data.pw.length) {
        this.data.pw.pop()
      }
      if ((num !== undefined && num !== '-1') && this.data.pw.length < 6) {
        this.data.pw.push(num)
      }
      this.setData({
        pw: this.data.pw
      })
      this.check()
    },
    check() {
      if (this.data.pw.length === 6) {
        wx.showLoading({
          title: '正在支付',
          mask: true
        })
        const arr = _this.paySign.split('##')
        const self = this
        wx.request({
          method: 'POST',
          url: decodeURIComponent(arr[5]),
          header: {
            token: arr[2]
          },
          data: {
            id: Number(arr[1]),
            order_number: _this._package.split('=')[1]
          },
          success(res) {
            self.setData({
              success: true
            })
            self.data.tempRes = res
            wx.hideLoading()
          },
          fail(err) {
            _this.fail(err)
            _this.complete(err)
            wx.hideLoading()
            self.hide()
          }
        })
      }
    },
    success() {
      const res = this.data.tempRes
      _this.success(res)
      _this.complete(res)
      this.hide()
    }
  }
})
